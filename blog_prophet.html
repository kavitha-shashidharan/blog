<!DOCTYPE html>
<html lang="en">
<head>
          <title>Kavitha's blog - Prophet Regression</title>
        <meta charset="utf-8" />
        <link href="https://kavitha-shashidharan.github.io/blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Kavitha's blog Full Atom Feed" />
        <link href="https://kavitha-shashidharan.github.io/blog/feeds/misc.atom.xml" type="application/atom+xml" rel="alternate" title="Kavitha's blog Categories Atom Feed" />




    <meta name="tags" content="python" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://kavitha-shashidharan.github.io/blog/">Kavitha's blog <strong></strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li class="active"><a href="https://kavitha-shashidharan.github.io/blog/category/misc.html">misc</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://kavitha-shashidharan.github.io/blog/blog_prophet.html" rel="bookmark"
         title="Permalink to Prophet Regression">Prophet Regression</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2019-10-29T11:10:00-04:00">
      Tue 29 October 2019
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://kavitha-shashidharan.github.io/blog/author/kavitha-shashidharan.html">Kavitha Shashidharan</a>
    </address>
    <div class="category">
        Category: <a href="https://kavitha-shashidharan.github.io/blog/category/misc.html">misc</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://kavitha-shashidharan.github.io/blog/tag/python.html">python</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <h3>Predicting the price of rice using prophet</h3>
<p>Prophet is a procedure for forecasting time series data. It is based on an additive model where non-linear trends are fit with yearly and weekly seasonality, plus holidays. It works best with daily periodicity data with at least one year of historical data. Prophet is robust to missing data, shifts in the trend, and large outliers. Being raised in south India, Rice is my families staple diet. I intend to use the price history of Rice and Prophet to predict the future price of rice. Are there opportunities to stack and save!</p>
<p>The rice.csv file, contains all price of rice in Indian currency since 2014. This data was obtained from www.indexmundi.com.</p>
<p>Loading up pandas and the purchases data:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="kn">from</span> <span class="nn">fbprophet</span> <span class="kn">import</span> <span class="n">Prophet</span>
</pre></div>


<p>Creating a dataframe with rice.csv</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="n">price</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/rice.csv&#39;</span><span class="p">)</span>
<span class="n">price</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
<span class="n">price</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>


<p><img src='images/blog4_img1.png' width="400"></p>
<p>Though the data set is quite simple, time for some basic EDA. The 'Price' column should be indexed as a float instead of string</p>
<div class="highlight"><pre><span></span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">=</span> <span class="p">(</span><span class="n">price</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="n">price</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">price</span><span class="o">.</span><span class="n">Price</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
<span class="n">price</span><span class="o">.</span><span class="n">dtypes</span>
</pre></div>


<p><img src='images/blog4_img2.png' width="300"></p>
<p>Prophet only takes data as a dataframe with a ds (datestamp) and y (value we want to forecast) column. So first, let’s convert the dataframe to the appropriate format. This is followed by the below steps:</p>
<p>Create a dataframe with the dates for which we want a prediction to be made with make_future_dataframe(). Then specify the number of days to forecast using the periods parameter.</p>
<p>Call predict to make a prediction and store it in the forecast dataframe. What’s neat here is that you can inspect the dataframe and see the predictions as well as the lower and upper boundaries of the uncertainty interval.</p>
<div class="highlight"><pre><span></span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span><span class="p">[[</span><span class="s1">&#39;Month&#39;</span><span class="p">,</span> <span class="s1">&#39;Price&#39;</span><span class="p">]]</span>
<span class="n">price</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
<span class="n">price</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>


<p><img src='images/blog4_img3.png' width="300"></p>
<p>Import prophet</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fbprophet</span> <span class="kn">import</span> <span class="n">Prophet</span>
</pre></div>


<p>In order to forecast values one year into the future we need to use the .make_future_dataframe. Since we are dealing with data on monthly frequency, we have to set the regressor know about this. Two parameters - periods and freq are used to set this explicity.</p>
<div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="n">Prophet</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">make_future_dataframe</span><span class="p">(</span><span class="n">periods</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;M&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</pre></div>


<p><img src='images/blog4_img4.png' width="300"></p>
<div class="highlight"><pre><span></span><span class="n">future_price</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
<span class="n">future_price</span><span class="p">[[</span><span class="s1">&#39;ds&#39;</span><span class="p">,</span> <span class="s1">&#39;yhat&#39;</span><span class="p">,</span> <span class="s1">&#39;yhat_lower&#39;</span><span class="p">,</span> <span class="s1">&#39;yhat_upper&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>


<p><img src='images/blog4_img5.png' width="500"></p>
<h2>Visualizing the prediction</h2>
<p>The forecast can be plotted by calling plot and passing in the forecast dataframe. The black dots represent outliers and the light-blue shaded regions are the uncertainty range. It looks like the forecast is signalling a sharp decrease in Rice price for the next 3 months and normalizing in the medium range (3- 12 months).</p>
<div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">register_matplotlib_converters</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">forecast</span><span class="p">);</span>
</pre></div>


<p><img src='images/blog4_img6.png' width="600"></p>
<div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">plot_components</span><span class="p">(</span><span class="n">forecast</span><span class="p">);</span>
</pre></div>


<p><img src='images/blog4_img7.png' width="600"></p>
<p>We can interpret that the price trend in on a increamental path (keep up with other grocery price trends). Yearly seasonality of price appears to be most expensive in Febraury and lowest in April.</p>
<h2>Evaluate the Predictor</h2>
<p>Keeping in line with other regressors of SciKit, Prophet allows us to perform cross validation. Use the cross_validation() function on the model and specify the forecast horizon with the horizon parameter. Next, call performance_metrics() to get a table with various prediction performance metrics.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fbprophet.diagnostics</span> <span class="kn">import</span> <span class="n">cross_validation</span><span class="p">,</span> <span class="n">performance_metrics</span>
<span class="n">df_cv</span> <span class="o">=</span> <span class="n">cross_validation</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="s1">&#39;90 days&#39;</span><span class="p">)</span>
<span class="n">df_p</span> <span class="o">=</span> <span class="n">performance_metrics</span><span class="p">(</span><span class="n">df_cv</span><span class="p">)</span>
<span class="n">df_p</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>


<p><img src='images/blog4_img8.png' width="600"></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fbprophet.plot</span> <span class="kn">import</span> <span class="n">plot_cross_validation_metric</span>
<span class="n">fig3</span> <span class="o">=</span> <span class="n">plot_cross_validation_metric</span><span class="p">(</span><span class="n">df_cv</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;mape&#39;</span><span class="p">)</span>
</pre></div>


<p><img src='images/blog4_img9.png' width="600"></p>
<p>We plot the mean absolute percent error (MAPE) instead of the mean squared error (MSE) simply because it is easier to interpret. We see for this forecast that accuracy fluctates between 10 to 20% over a course of 90 days.</p>
<h2>Conclusion</h2>
<p>Prophet offers easily mode of predicting time series data based on historical time series data. It also offers various visualization and thus is a well rounded regression tool.</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>